name: CI

on:
  pull_request:
  push:
    branches: [main, develop]
  # This avoids duplicate runs:
  # - PR branches trigger pull_request (not push)
  # - Direct pushes to main/develop trigger push (post-merge validation)

jobs:
  ruff:
    name: Ruff Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
      - name: Install uv
        run: curl -Ls https://astral.sh/uv/install.sh | sh
      - name: Add uv to PATH
        run: echo "$HOME/.local/bin" >> $GITHUB_PATH
      - name: Cache uv
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/uv
            .venv
          key: ci-ruff-${{ runner.os }}-${{ hashFiles('pyproject.toml', 'uv.lock') }}
          restore-keys: |
            ci-ruff-${{ runner.os }}-
      - name: Sync dependencies
        run: uv sync --dev
      - name: Run Ruff Lint
        run: uv run ruff check --output-format=github
      - name: Run Ruff Format Check
        run: uv run ruff format --check --diff

  ty:
    name: Ty Type Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
      - name: Install uv
        run: curl -Ls https://astral.sh/uv/install.sh | sh
      - name: Add uv to PATH
        run: echo "$HOME/.local/bin" >> $GITHUB_PATH
      - name: Cache uv
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/uv
            .venv
          key: ci-ty-${{ runner.os }}-${{ hashFiles('pyproject.toml', 'uv.lock') }}
          restore-keys: |
            ci-ty-${{ runner.os }}-
      - name: Sync dependencies
        run: uv sync --dev
      - name: Run Ty
        run: uvx ty check || true

  bandit:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.14'
      - name: Install uv
        run: curl -Ls https://astral.sh/uv/install.sh | sh
      - name: Add uv to PATH
        run: echo "$HOME/.local/bin" >> $GITHUB_PATH
      - name: Run Bandit
        run: uvx bandit -r src/ -ll -f json -o bandit-report.json || true
      - name: Display Bandit Results
        run: uvx bandit -r src/ -ll || true

  safety:
    name: Dependency Vulnerability Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.14'
      - name: Install uv
        run: curl -Ls https://astral.sh/uv/install.sh | sh
      - name: Add uv to PATH
        run: echo "$HOME/.local/bin" >> $GITHUB_PATH
      - name: Cache uv
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/uv
            .venv
          key: ci-safety-${{ runner.os }}-${{ hashFiles('pyproject.toml', 'uv.lock') }}
          restore-keys: |
            ci-safety-${{ runner.os }}-
      - name: Sync dependencies
        run: uv sync --dev
      - name: Run Safety Check
        run: uv run safety check --json || true

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
      - name: Install uv
        run: curl -Ls https://astral.sh/uv/install.sh | sh
      - name: Add uv to PATH
        run: echo "$HOME/.local/bin" >> $GITHUB_PATH
      - name: Cache uv
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/uv
            .venv
          key: ci-test-${{ runner.os }}-${{ hashFiles('pyproject.toml', 'uv.lock') }}
          restore-keys: |
            ci-test-${{ runner.os }}-
      - name: Sync dependencies
        run: uv sync --dev
      - name: Run smoke tests
        run: |
          set -euo pipefail
          tests=("tests/test_reply_and_threads.py" "tests/test_identity_resources.py")
          existing=()
          for test_path in "${tests[@]}"; do
            if [ -f "$test_path" ]; then
              existing+=("$test_path")
            else
              echo "Skipping missing smoke test: $test_path"
            fi
          done
          if [ ${#existing[@]} -eq 0 ]; then
            echo "No smoke tests found; skipping smoke suite"
            exit 0
          fi
          uv run pytest -v "${existing[@]}"
