name: Publish to PyPI

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      force_publish:
        description: 'Force publish (skip delta detection)'
        required: false
        type: boolean
        default: false

jobs:
  check-changes:
    name: Check for package changes
    runs-on: ubuntu-latest
    outputs:
      should_publish: ${{ steps.detect.outputs.should_publish }}
      changes_summary: ${{ steps.detect.outputs.changes_summary }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for tag comparison

      - name: Detect package changes
        id: detect
        run: |
          # If manual dispatch with force_publish, always publish
          if [[ "${{ github.event.inputs.force_publish }}" == "true" ]]; then
            echo "should_publish=true" >> $GITHUB_OUTPUT
            echo "changes_summary=Force publish requested" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Get previous tag
          PREVIOUS_TAG=$(git tag --sort=-v:refname | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | sed -n '2p')
          CURRENT_TAG=${GITHUB_REF#refs/tags/}

          if [[ -z "$PREVIOUS_TAG" ]]; then
            echo "should_publish=true" >> $GITHUB_OUTPUT
            echo "changes_summary=First release - no previous tag found" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Comparing $PREVIOUS_TAG...$CURRENT_TAG"

          # Check for changes in package-related files
          CHANGED_FILES=$(git diff --name-only "$PREVIOUS_TAG" "$CURRENT_TAG" || echo "")

          # Package-critical paths
          PACKAGE_PATHS=(
            "src/"
            "pyproject.toml"
            "uv.lock"
            "README.md"
            "LICENSE"
          )

          CHANGES_FOUND=false
          CHANGES_LIST=""

          for path in "${PACKAGE_PATHS[@]}"; do
            if echo "$CHANGED_FILES" | grep -q "^${path}"; then
              CHANGES_FOUND=true
              COUNT=$(echo "$CHANGED_FILES" | grep "^${path}" | wc -l | tr -d ' ')
              CHANGES_LIST="${CHANGES_LIST}- ${path}: ${COUNT} files\n"
            fi
          done

          if [[ "$CHANGES_FOUND" == "true" ]]; then
            echo "should_publish=true" >> $GITHUB_OUTPUT
            echo "changes_summary<<EOF" >> $GITHUB_OUTPUT
            echo -e "Package changes detected:\n${CHANGES_LIST}" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "should_publish=false" >> $GITHUB_OUTPUT
            echo "changes_summary=No package-related changes detected since $PREVIOUS_TAG" >> $GITHUB_OUTPUT
          fi

  validate-version:
    name: Validate version bump
    runs-on: ubuntu-latest
    needs: check-changes
    if: needs.check-changes.outputs.should_publish == 'true'
    outputs:
      version: ${{ steps.get-version.outputs.version }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Get version from pyproject.toml
        id: get-version
        run: |
          VERSION=$(grep '^version = ' pyproject.toml | sed 's/version = "\(.*\)"/\1/')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Package version: $VERSION"

      - name: Verify tag matches version
        run: |
          TAG_VERSION=${GITHUB_REF#refs/tags/v}
          PYPROJECT_VERSION="${{ steps.get-version.outputs.version }}"

          if [[ "$TAG_VERSION" != "$PYPROJECT_VERSION" ]]; then
            echo "ERROR: Tag version ($TAG_VERSION) doesn't match pyproject.toml version ($PYPROJECT_VERSION)"
            exit 1
          fi
          echo "âœ… Version validation passed: $TAG_VERSION"

  publish:
    name: Build and publish to PyPI
    runs-on: ubuntu-latest
    needs: [check-changes, validate-version]
    if: needs.check-changes.outputs.should_publish == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install uv
        run: curl -LsSf https://astral.sh/uv/install.sh | sh

      - name: Build package
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          uv build

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          password: ${{ secrets.PYPI_API_TOKEN }}

      - name: Create release summary
        run: |
          echo "## ðŸŽ‰ Published to PyPI" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Package:** mcp-mail" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ needs.validate-version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**PyPI URL:** https://pypi.org/project/mcp-mail/${{ needs.validate-version.outputs.version }}/" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Changes" >> $GITHUB_STEP_SUMMARY
          echo "${{ needs.check-changes.outputs.changes_summary }}" >> $GITHUB_STEP_SUMMARY

  skip-publish:
    name: Skip publishing
    runs-on: ubuntu-latest
    needs: check-changes
    if: needs.check-changes.outputs.should_publish == 'false'
    steps:
      - name: Report skip
        run: |
          echo "## â­ï¸ Publishing Skipped" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "${{ needs.check-changes.outputs.changes_summary }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "To force publish, re-run this workflow with 'force_publish' enabled." >> $GITHUB_STEP_SUMMARY
